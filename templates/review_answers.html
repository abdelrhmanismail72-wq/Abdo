{% extends 'base.html' %}
{% load extra_filters %}
{% block content %}
<style>
  .question-card {
    border-left: 4px solid #0d6efd;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
  }
  /* Desktop styles - ensure header is always visible */
  .table thead {
    display: table-header-group;
  }

  /* Mobile styles */
  @media (max-width: 767.98px) {
    .table-responsive {
      border: 0;
    }
    .table thead {
      display: none;
    }
    .table tr {
      display: block;
      margin-bottom: 1.5rem;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      overflow: hidden;
    }
    .table td {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem;
      border-bottom: 1px solid #dee2e6;
    }
    .table td::before {
      content: attr(data-label);
      font-weight: bold;
      margin-left: 0.5rem;
      color: #6c757d;
    }
    .table td:last-child {
      border-bottom: 0;
    }
  }
</style>

<div class="container py-3">
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
      <h2 class="h5 h4-md mb-0">
        <i class="fas fa-clipboard-check me-2"></i>
        مراجعة إجاباتك في اختبار: {{ attempt.test.title }}
      </h2>
    </div>
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
            <tr>
              <th class="text-center" style="width: 5%;">#</th>
              <th style="width: 40%;">السؤال</th>
              <th style="width: 20%;">إجابتك</th>
              <th class="text-center" style="width: 15%;">الحالة</th>
              <th style="width: 20%;">الإجابة الصحيحة</th>
            </tr>
          </thead>
          <tbody>
            {% for q in questions %}
              {% with ans=student_answers|get:q.id %}
              <tr class="{% if ans %}{% if ans|stringformat:'i' == q.correct_answer|stringformat:'i' %}table-success{% else %}table-danger{% endif %}{% else %}table-warning{% endif %} question-card">
                <td class="text-center fw-bold" data-label="رقم السؤال">{{ forloop.counter }}</td>
                <td data-label="السؤال">
                  <div class="d-flex flex-column">
                    {% if q.text %}<div class="mb-2">{{ q.text }}</div>{% endif %}
                    {% if q.image %}
                      <div class="text-center">
                        <img src="{{ q.image.url }}" class="img-fluid rounded" style="max-height: 150px; width: auto;">
                      </div>
                    {% endif %}
                  </div>
                </td>
                <td data-label="إجابتك">
                  {% if ans %}
                    <span class="badge {% if ans|stringformat:'i' == q.correct_answer|stringformat:'i' %}bg-success{% else %}bg-danger{% endif %} p-2 d-inline-block w-100 text-truncate">
                      {{ q.get_choices|slice:ans|last }}
                    </span>
                  {% else %}
                    <span class="badge bg-secondary p-2 d-inline-block w-100">لم تجب</span>
                  {% endif %}
                </td>
                <td class="text-center" data-label="الحالة">
                  {% if ans %}
                    {% if ans|stringformat:'i' == q.correct_answer|stringformat:'i' %}
                      <span class="badge bg-success p-2">
                        <i class="fas fa-check-circle me-1"></i> <span class="d-none d-md-inline">صحيح</span>
                      </span>
                    {% else %}
                      <span class="badge bg-danger p-2">
                        <i class="fas fa-times-circle me-1"></i> <span class="d-none d-md-inline">خطأ</span>
                      </span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-warning text-dark p-2">
                      <i class="fas fa-question-circle me-1"></i> <span class="d-none d-md-inline">لم تجب</span>
                    </span>
                  {% endif %}
                </td>
                <td data-label="الإجابة الصحيحة">
                  <span class="badge bg-primary p-2 d-inline-block w-100 text-truncate">
                    {{ q.correct_choice_text }}
                  </span>
                </td>
              </tr>
              {% endwith %}
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <div class="d-flex flex-column flex-md-row justify-content-between align-items-center p-3 border-top">
        <div class="d-flex flex-wrap justify-content-center justify-content-md-start mb-3 mb-md-0">
          <span class="badge bg-success me-2 mb-2 mb-md-0">
            <i class="fas fa-check-circle me-1"></i> <span class="d-none d-sm-inline">صحيح</span>
          </span>
          <span class="badge bg-danger me-2 mb-2 mb-md-0">
            <i class="fas fa-times-circle me-1"></i> <span class="d-none d-sm-inline">خطأ</span>
          </span>
          <span class="badge bg-warning text-dark me-2 mb-2 mb-md-0">
            <i class="fas fa-question-circle me-1"></i> <span class="d-none d-sm-inline">لم تجب</span>
          </span>
        </div>
        <a href="{% url 'home' %}" class="btn btn-primary w-100 w-md-auto">
          <i class="fas fa-home me-1"></i> العودة للصفحة الرئيسية
        </a>
      </div>
    </div>
  </div>
</div>

<script>
// Make table rows clickable on mobile to show/hide details
document.addEventListener('DOMContentLoaded', function() {
  if (window.innerWidth < 768) {
    const rows = document.querySelectorAll('tbody tr');
    rows.forEach(row => {
      row.addEventListener('click', function() {
        this.classList.toggle('active');
      });
    });
  }
});
</script>
{% endblock %}